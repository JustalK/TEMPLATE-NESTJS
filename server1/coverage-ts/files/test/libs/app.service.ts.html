
  <!DOCTYPE html>
  <html>
    <head>
      <title>app.service.ts</title>
      <link href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" type="text/css" rel="stylesheet">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/mode/javascript/javascript.min.js" type="text/javascript" charset="utf-8"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.css" type="text/css" rel="stylesheet">
<script src="../../../assets/source-file.js" type="text/javascript" charset="utf-8"></script>
<link href="../../../assets/source-file.css" type="text/css" rel="stylesheet">
    </head>
    <body>
    <div style="margin-top:3em" class="ui container"><h1 class="ui header"><a href="../../../index.html">TypeScript coverage report</a></h1><table style="margin-top:2em" class="ui celled table"><thead class=""><tr class=""><th class="">Filename</th><th class="">Percent</th><th class="">Threshold</th><th class="">Total</th><th class="">Covered</th><th class="">Uncovered</th></tr></thead><tbody class=""><tr class="positive"><td class="">test/libs/app.service.ts</td><td class="">98.92%</td><td class="">90%</td><td class="">93</td><td class="">92</td><td class="">1</td></tr></tbody></table><textarea id="editor" readonly="" style="margin-top:3em">import { INestApplication } from &#x27;@nestjs/common&#x27;;
import { Test, TestingModule } from &#x27;@nestjs/testing&#x27;;
import { AppModule } from &#x27;@src/app.module&#x27;;
import { MongoMemoryServer } from &#x27;mongodb-memory-server&#x27;;
import { SeederService } from &#x27;@test/libs/seeder.service&#x27;;
import { MongooseModule, getConnectionToken } from &#x27;@nestjs/mongoose&#x27;;
import request from &#x27;supertest-graphql&#x27;;
import requestHTTP from &#x27;supertest&#x27;;
import { DocumentNode } from &#x27;graphql&#x27;;

/**
 * The App testing service
 * Define how to start, stop and manage the testing server
 */
export class AppService {
  mongoServer: MongoMemoryServer;
  moduleFixture: TestingModule;
  app: INestApplication;
  dbConnection: TestingModule;
  uri: string;

  /**
   * Start the testing server and seed it
   */
  async start() {
    await this.init();
    const seederService = new SeederService(this.moduleFixture);
    await seederService.seed();
  }

  /**
   * Initialize the testing server with the right informaton
   */
  async init() {
    this.moduleFixture = await Test.createTestingModule({
      imports: [
        AppModule,
        // For service: https://dev.to/webeleon/unit-testing-nestjs-with-mongo-in-memory-54gd
        MongooseModule.forRootAsync({
          useFactory: async () =&gt; {
            this.mongoServer = await MongoMemoryServer.create();
            return { uri: this.mongoServer.getUri() };
          },
        }),
      ],
    }).compile();

    this.app = this.moduleFixture.createNestApplication();
    this.dbConnection = await this.moduleFixture.get(getConnectionToken());

    await this.app.init();
  }

  /**
   * Execute request against the testing server
   * @param query The query gql to execute
   * @param variables The variables to pass to the query
   * @return The result of the call
   */
  async query(query: DocumentNode, variables) {
    return request(this.app.getHttpServer()).mutate(query).variables(variables);
  }

  /**
   * Execute request against the testing server
   * @param query The query gql to execute
   * @param variables The variables to pass to the query
   * @return The result of the call
   */
  async queryHTTP(path = &#x27;&#x27;) {
    return requestHTTP(this.app.getHttpServer()).get(path);
  }

  /**
   * Stop the testing server and remove all active connection
   */
  async stop() {
    await this.dbConnection.close();
    await this.mongoServer.stop();
    await this.app.close();
  }
}
</textarea><pre id="annotations" style="display:none">[{&quot;file&quot;:&quot;test/libs/app.service.ts&quot;,&quot;line&quot;:59,&quot;character&quot;:35,&quot;text&quot;:&quot;variables&quot;,&quot;kind&quot;:1}]</pre></div>
    <p class="footer-text">TypeScript Coverage Report generated by <a href="https://github.com/plantain-00/type-coverage">type-coverage</a> and <a href="https://github.com/alexcanessa/typescript-coverage-report">typescript-coverage-report</a> at Fri, 01 Jul 2022 19:28:46 GMT</p>
    </body>
  </html>
  